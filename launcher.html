<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Launcher</title>
    <meta name="color-scheme" content="light dark" />
    <style>
        :root {
            --bg: #0b0c10;
            --panel: #141824;
            --txt: #e8e8ea;
            --muted: #a8acb3;
            --bd: #2a2f3a;
            --btn: #1f6feb;
            --ok: #3ddc84;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: transparent;
            color: var(--txt);
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--bd);
            border-radius: 14px;
            padding: 16px;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 16px;
            margin: 0 0 8px 0;
        }

        p {
            margin: 0 0 12px 0;
            color: var(--muted);
            font-size: 12px;
            line-height: 1.35;
        }

        button {
            width: 100%;
            padding: 14px 14px;
            border-radius: 14px;
            border: 1px solid rgba(31, 111, 235, .45);
            background: var(--btn);
            color: var(--txt);
            font-weight: 750;
            cursor: pointer;
            font-size: 14px;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .btn2 {
            flex: 1;
            min-width: 160px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--bd);
            background: transparent;
            color: var(--txt);
            font-weight: 650;
            cursor: pointer;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size: 12px;
            color: var(--muted);
            word-break: break-all;
        }

        .list {
            margin-top: 12px;
            border: 1px solid var(--bd);
            border-radius: 12px;
            overflow: hidden;
        }

        .item {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-top: 1px solid var(--bd);
        }

        .item:first-child {
            border-top: none;
        }

        .k {
            color: var(--muted);
            font-size: 12px;
        }

        .v {
            font-weight: 750;
            word-break: break-all;
        }

        .pill {
            font-size: 12px;
            border: 1px solid var(--bd);
            border-radius: 999px;
            padding: 4px 8px;
            color: var(--muted);
        }

        .ok {
            color: var(--ok);
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>Multi-Scan</h1>
        <p>Startet den Scanner im selben iFrame. Nach Abschluss werden die Werte gespeichert und hier angezeigt.</p>

        <button id="btnStart">Multi-Scan starten</button>

        <div class="row">
            <button class="btn2" id="btnCopy" type="button">Alle Werte kopieren</button>
            <button class="btn2" id="btnClear" type="button">Ergebnis löschen</button>
        </div>

        <div class="mono" style="margin-top:10px;">
            count: <span id="cnt"></span>
        </div>

        <div id="out" class="list" style="display:none;"></div>
        <div id="empty" class="mono" style="margin-top:12px;">Noch keine Scans vorhanden.</div>

        <div id="copyMsg" class="mono ok" style="margin-top:10px; display:none;">Kopiert.</div>
    </div>

    <script>
        const STORAGE_KEY = "scanapp:last";
        const qs = new URLSearchParams(location.search);
        const count = Math.max(1, Math.min(50, Number(qs.get("count") || "5")));
        document.getElementById("cnt").textContent = String(count);

        function loadResult() {
            try {
                const raw = sessionStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch {
                return null;
            }
        }

        function render() {
            const out = document.getElementById("out");
            const empty = document.getElementById("empty");
            const res = loadResult();

            if (!res || !res.values || !Object.keys(res.values).length) {
                out.style.display = "none";
                out.innerHTML = "";
                empty.style.display = "block";
                return;
            }

            empty.style.display = "none";
            out.style.display = "block";
            out.innerHTML = "";

            for (let i = 1; i <= res.count; i++) {
                const key = `barcode${i}`;
                const val = res.values[key] || "";
                const row = document.createElement("div");
                row.className = "item";
                row.innerHTML = `
          <div>
            <div class="k">barcode${i}</div>
            <div class="v">${escapeHtml(val) || "<span style='opacity:.5'>—</span>"}</div>
          </div>
          <div class="pill">${val ? "OK" : "offen"}</div>
        `;
                out.appendChild(row);
            }
        }

        function escapeHtml(s) {
            return String(s)
                .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
        }

        function buildCopyText() {
            const res = loadResult();
            if (!res || !res.values) return "";
            const lines = [];
            for (let i = 1; i <= res.count; i++) {
                const k = `barcode${i}`;
                lines.push(`${k}: ${res.values[k] || ""}`);
            }
            return lines.join("\n");
        }

        document.getElementById("btnStart").addEventListener("click", () => {
            // Navigate within same iframe
            const u = new URL("multiscan.html", location.href);
            u.searchParams.set("count", String(count));
            u.searchParams.set("cooldown", qs.get("cooldown") || "900");
            location.href = u.toString();
        });

        document.getElementById("btnClear").addEventListener("click", () => {
            sessionStorage.removeItem(STORAGE_KEY);
            render();
        });

        document.getElementById("btnCopy").addEventListener("click", async () => {
            const text = buildCopyText();
            if (!text) return;
            try {
                await navigator.clipboard.writeText(text);
                const msg = document.getElementById("copyMsg");
                msg.style.display = "block";
                setTimeout(() => msg.style.display = "none", 1200);
            } catch {
                // fallback: prompt
                window.prompt("Kopiere den Text:", text);
            }
        });

        render();
    </script>
</body>

</html>